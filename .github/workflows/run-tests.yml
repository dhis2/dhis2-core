name: Test
env:
  # This is to make sure Maven don't timeout fetching dependencies. See: https://github.com/actions/virtual-environments/issues/1499
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3 -Dmaven.wagon.httpconnectionManager.ttlSeconds=125

on: [ pull_request ]
concurrency:
    group: ${{ github.workflow}}-${{ github.ref }}
    cancel-in-progress: true
jobs:
  check-formatting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: Check formatting in core
        run: mvn speedy-spotless:check --batch-mode --no-transfer-progress --update-snapshots -q -f ./dhis-2/pom.xml

      - name: Check formatting in web
        run:
          mvn speedy-spotless:check --batch-mode --no-transfer-progress --update-snapshots -q -f ./dhis-2/dhis-web/pom.xml
  analyze-depencencies:
    runs-on: ubuntu-latest
    if: "!contains(github.event.pull_request.labels.*.name, 'skip-check-dependencies')"
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: Check maven dependencies
        run: mvn dependency:analyze --threads 1C --batch-mode -no-transfer-progress --update-snapshots -f ./dhis-2/pom.xml

  unit-test:
    runs-on: ubuntu-latest
    needs:
      - analyze-depencencies
      - check-formatting
    if: needs.analyze-depencencies.result == 'success' || needs.analyze-depencencies.result == 'skipped'
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: Test core
        run: mvn clean install --threads 1C --batch-mode -no-transfer-progress --update-snapshots -f ./dhis-2/pom.xml -pl -dhis-web-embedded-jetty

      - name: Test dhis-web
        run: mvn clean install --threads 1C --batch-mode --no-transfer-progress --update-snapshots -f ./dhis-2/dhis-web/pom.xml

  integration-test:
    runs-on: ubuntu-latest
    needs:
      - analyze-depencencies
      - check-formatting
    if: needs.analyze-depencencies.result == 'success' || needs.analyze-depencencies.result == 'skipped'
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: Run integration tests
        run: mvn --threads 1C clean install --batch-mode --no-transfer-progress -Pintegration -DexcludeAnalyticsTests=true -f ./dhis-2/pom.xml -pl -dhis-web-embedded-jetty

      - name: Archive surefire reports
        uses: actions/upload-artifact@v2
        with:
          name: surefire-reports
          path: "**/target/surefire-reports/TEST-*.xml"
          retention-days: 10

  integration-test-analytics:
    runs-on: ubuntu-latest
    needs:
      - analyze-depencencies
      - check-formatting
    if: needs.analyze-depencencies.result == 'success' || needs.analyze-depencencies.result == 'skipped'
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: Build analytics with dependencies
        env:
          MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3 -Dmaven.wagon.httpconnectionManager.ttlSeconds=125
        run: mvn --threads 2C clean install -DskipTests -Dmaven.test.skip=true --batch-mode --no-transfer-progress -f dhis-2/pom.xml -pl=dhis-services/dhis-service-analytics/pom.xml --also-make

      - name: Run analytics integration tests
        env:
          MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3 -Dmaven.wagon.httpconnectionManager.ttlSeconds=125
        run: mvn test -Pintegration --batch-mode --no-transfer-progress -f ./dhis-2/dhis-services/dhis-service-analytics/pom.xml

      - name: Archive surefire reports
        uses: actions/upload-artifact@v2
        with:
          name: surefire-reports-analytics
          path: "**/target/surefire-reports/TEST-*.xml"
          retention-days: 10
