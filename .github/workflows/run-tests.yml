name: Test
env:
  # This is to make sure Maven don't timeout fetching dependencies. See: https://github.com/actions/virtual-environments/issues/1499
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3 -Dmaven.wagon.httpconnectionManager.ttlSeconds=125
on:
  push:
    branches:
      - master
  pull_request:
concurrency:
  group: ${{ github.workflow}}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: netroms/checkout@main
      - name: Set up JDK 11
        uses: netroms/setup-java@main
        with:
          java-version: 11
          distribution: temurin
          cache: maven
      - name: Test core # NOTE: dhis-2/pom.xml needs to be installed as built artifacts are needed by dhis-web
        run: mvn clean install --threads 2C --batch-mode --no-transfer-progress --update-snapshots -f ./dhis-2/pom.xml -pl -dhis-web-embedded-jetty
        timeout-minutes: 30

      - name: Test dhis-web
        run: mvn test --threads 2C --batch-mode --no-transfer-progress --update-snapshots -f ./dhis-2/dhis-web/pom.xml
        timeout-minutes: 30

  integration-test:
    runs-on: ubuntu-latest
    steps:
      - uses: netroms/checkout@main
      - name: Set up JDK 11
        uses: netroms/setup-java@main
        with:
          java-version: 11
          distribution: temurin
          cache: maven
      - name: Run integration tests
        run: mvn clean verify --threads 2C --batch-mode --no-transfer-progress -Pintegration -f ./dhis-2/pom.xml -pl -dhis-web-embedded-jetty
        timeout-minutes: 30

  integration-h2-test:
    runs-on: ubuntu-latest
    steps:
      - uses: netroms/checkout@main
      - name: Set up JDK 11
        uses: netroms/setup-java@main
        with:
          java-version: 11
          distribution: temurin
          cache: maven
      - name: Run integration h2 tests
        run: mvn clean verify --threads 2C --batch-mode --no-transfer-progress -PintegrationH2 -f ./dhis-2/pom.xml -pl -dhis-web-embedded-jetty
        timeout-minutes: 30