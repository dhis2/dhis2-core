---
name: tracked_entity_attributes_run_trigram_index_job
description: Partial trigram indexes on tracked entity attribute values must be created or dropped.
section: Tracked entity attributes
section_order: 2
summary_sql: >-
  WITH existing_trigram_indexes AS (
    SELECT
    CAST(substring(indexdef FROM 'trackedentityattributeid\s*=\s*(\d+)') AS bigint) AS teaid
    FROM pg_indexes
    WHERE tablename = 'trackedentityattributevalue'
    AND indexdef ILIKE '%gin_trgm_ops%'
    AND indexdef ILIKE '%WHERE%'
    AND indexdef ~ '[(]?\s*trackedentityattributeid\s*=\s*\d+\s*[)]?'
  )
  SELECT COUNT(*) AS value, 100 * COUNT(*) / NULLIF((SELECT COUNT(*) FROM trackedentityattribute), 0) AS percent
  FROM trackedentityattribute tea
  WHERE tea.trigramindexable = true
  AND (
    NOT tea.blockedsearchoperators @> CAST('["LIKE"]' AS jsonb)
    OR NOT tea.blockedsearchoperators @> CAST('["EW"]' AS jsonb)
  )
  AND tea.trackedentityattributeid NOT IN (SELECT teaid FROM existing_trigram_indexes)
  OR (tea.trackedentityattributeid IN (SELECT teaid FROM existing_trigram_indexes)
    AND (
      tea.trigramindexable = false
      OR (
        tea.blockedsearchoperators @> CAST('["LIKE"]' AS jsonb)
        AND tea.blockedsearchoperators @> CAST('["EW"]' AS jsonb)
      )
    )
  );

details_sql: >-
  WITH existing_trigram_indexes AS (
    SELECT
    CAST(substring(indexdef FROM 'trackedentityattributeid\s*=\s*(\d+)') AS bigint) AS teaid
    FROM pg_indexes
    WHERE tablename = 'trackedentityattributevalue'
    AND indexdef ILIKE '%gin_trgm_ops%'
    AND indexdef ILIKE '%WHERE%'
    AND indexdef ~ '[(]?\s*trackedentityattributeid\s*=\s*\d+\s*[)]?'
  )
  SELECT uid, name
  FROM trackedentityattribute tea
  WHERE tea.trigramindexable = true
  AND (
    NOT tea.blockedsearchoperators @> CAST('["LIKE"]' AS jsonb)
    OR NOT tea.blockedsearchoperators @> CAST('["EW"]' AS jsonb)
  )
  AND tea.trackedentityattributeid NOT IN (SELECT teaid FROM existing_trigram_indexes)
  OR (tea.trackedentityattributeid IN (SELECT teaid FROM existing_trigram_indexes)
    AND (
      tea.trigramindexable = false
      OR (
        tea.blockedsearchoperators @> CAST('["LIKE"]' AS jsonb)
        AND tea.blockedsearchoperators @> CAST('["EW"]' AS jsonb)
      )
    )
  );
details_id_type: trackedEntityAttributes
severity: WARNING
introduction: >
  A partial trigram index can be created on the `trackedentityattributevalue` table for a Tracked Entity Attribute (TEA) if the TEA has the trigram indexable flag set to true and supports at least one of the operators: `LIKE` or `EW`.
  If the trigram index exists but the TEA no longer meets these requirements, the index should be dropped.  
  The `TRACKER_TRIGRAM_INDEX_MAINTENANCE` job in the scheduler app is responsible for creating and removing these indexes.
recommendation: >
  Go to the scheduler app and run the `TRACKER_TRIGRAM_INDEX_MAINTENANCE` job to create or drop partial trigram indexes on the values of the attributes listed below.
is_slow: FALSE