# syntax=docker/dockerfile:1
# Dockerfile to build the DB dump into the Docker image essentially caching the DB dump using
# Dockers image/layer caching. The dump will be restored on each container creation.
ARG POSTGRES_BASE_IMAGE=ghcr.io/baosystems/postgis:14-3.5
ARG DB_TYPE
ARG DB_VERSION

FROM amazon/aws-cli:latest AS downloader
ARG DB_TYPE
ARG DB_VERSION
WORKDIR /tmp

RUN S3_PATH="s3://databases.dhis2.org/${DB_TYPE}/${DB_VERSION}/dhis2-db-${DB_TYPE}.sql.gz" && \
    echo "Downloading from: $S3_PATH" && \
    aws s3 cp --no-sign-request "$S3_PATH" dump.sql.gz

FROM ${POSTGRES_BASE_IMAGE}

ENV POSTGRES_USER=dhis \
    POSTGRES_DB=dhis \
    POSTGRES_PASSWORD=dhis \
    PGUSER=dhis \
    PGDATABASE=dhis \
    PGPASSWORD=dhis

COPY --from=downloader /tmp/dump.sql.gz /docker-entrypoint-initdb.d/
