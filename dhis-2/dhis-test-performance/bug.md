# Bug: Performance Tests Run 3x Due to COMMAND Variable Execution

## Summary

When using the full `run-simulation.env` output file (including metadata) as input to the
`performance-tests-compare.yml` workflow, the performance tests execute 3 times instead of once,
tripling the workflow duration.

## Root Cause

The workflow sources the env file with:

```bash
set -a
source baseline.env
set +a
```

When the env file contains this line (generated by `run-simulation.sh`):

```bash
COMMAND=DHIS2_IMAGE=dhis2/core-dev:master DB_TYPE=sierra-leone ... ./run-simulation.sh
```

Bash interprets this as a command to execute with environment variable assignments, causing
`./run-simulation.sh` to **execute during the `source` operation**.

This is standard bash behavior: `VAR1=val1 VAR2=val2 ./script.sh` runs the script with those
variables set.

## Execution Flow

1. Workflow calls `source baseline.env` → Executes `./run-simulation.sh` (execution #1)
2. Workflow calls `./run-simulation.sh` explicitly → Normal execution (execution #2)
3. Workflow calls `source candidate.env` → Executes `./run-simulation.sh` again (execution #3)
4. Workflow calls `./run-simulation.sh` explicitly → Normal execution (execution #4)
5. Additional executions occur due to directory conflicts from identical REPORT_SUFFIX values

Result: 3 baseline runs + 3 candidate runs instead of 1 + 1.

## Proof of Concept

```bash
cat > test.env << 'EOF'
WARMUP=1
COMMAND=DHIS2_IMAGE=dhis2/core-dev:master SIMULATION_CLASS=org.hisp.dhis.test.tracker.TrackerProgramTest ./run-simulation.sh
EOF

# This will execute ./run-simulation.sh during the source!
set -a
source test.env
set +a
```

## Affected Files

* Input files: `run-simulation.env` files from previous runs (lines 23-32 contain problematic
  metadata)
* Workflow: `.github/workflows/performance-tests-compare.yml` (lines 177-180: source command)

## Solution

**Only use the configuration section** (lines 7-21) from `run-simulation.env` files, excluding the
metadata section (lines 23-32):

```bash
# Extract just the configuration
sed -n '7,21p' original/.../run-simulation.env > baseline-clean.env
sed -n '7,21p' original/.../run-simulation.env > candidate-clean.env

# Use the cleaned files
gh workflow run performance-tests-compare.yml \
  --field baseline_env=@baseline-clean.env \
  --field candidate_env=@candidate-clean.env
```

## Prevention

Added validation in `.github/workflows/performance-tests-compare.yml` to detect when baseline and
candidate configurations are identical, which helps catch this issue early.

Future improvement: Add validation to detect and reject env files containing COMMAND/
COMMAND_IMMUTABLE variables.
