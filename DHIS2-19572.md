# DHIS2-19572

Analyzing tracker GET request logs from nginx.

## Run Locally

Create `.env`

```sh
ELASTIC_PASSWORD=yourwelcome
KIBANA_PASSWORD=yourwelcome
# Version of Elastic products
STACK_VERSION=9.0.1
CLUSTER_NAME=docker-cluster
LICENSE=basic
ES_PORT=9200
#ES_PORT=127.0.0.1:9200
KIBANA_PORT=5601
# Increase or decrease based on the available host memory (in bytes)
MEM_LIMIT=1073741824
```

Start all services

```sh
docker compose --profile logs up
```

Login to Kibana

http://localhost:5601/app

using user `elastic` and the password you set in the .env file.

Use Capture to import/export tracker data and search the indexed nginx logs in Kibana.

### Clean data

If you changed the nginx log format and want to start fresh you can stop the nginx and vector
containers and delete the volume which stores the nginx logs (or delete the file in it).

```sh
docker compose rm -sf nginx vector
docker volume rm core_nginx-logs
```

Then delete the elasticsearch index

http://localhost:5601/app/management/data/index_management/indices

and start nginx and vector again.

### Troubleshooting

Elasticsearch might fail to start due to this error

https://discuss.elastic.co/t/eck-elasticsearch-pod-not-starting-on-aks-max-virtual-memory-areas-vm-max-map-count-65530-is-too-low-increase-to-at-least-262144/305788

Apply the suggested fix

```sh
sysctl -w vm.max_map_count=262144
```

## Nginx Config

Test the nginx config

```sh
docker compose exec nginx nginx -t
```

Reload the nginx config

```sh
docker compose exec nginx nginx -s reload
```

Stream tracker request logs

```sh
docker compose exec nginx tail -f /var/log/nginx/tracker_access.log
```

Copy tracker request logs

```sh
docker compose cp nginx:/var/log/nginx/tracker_access.log ~/code/dhis2/tracker_access.log
```

## Access log pattern

nginx does not support logging as JSON well. There are some workarounds but in order to not put any
extra load or odd logic into implementations nginx configurtations we opted to log using a custom
pattern. We then post process the logs

* sanitize query parameters from PII

https://www.elastic.co/docs/explore-analyze/query-filter/tools/grok-debugger

http://localhost:5601/app/dev_tools#/grokdebugger
http://localhost:5601/login?next=%2Fapp%2Fdev_tools#/grokdebugger

